# 文档概述
# 功能概述
# 功能描述
## 前提说明
* 统一术语
  * 外网：非 Neutron 管理的网络
  * 内网：Neutron 管理的网络
  * 路由器外网接口：通向外部网络的接口
  * 北向：实例
  * 南向：广域网
  * 上行：进外网
  * 下行：出外网

* 监控方式

| **监控时间范围** | **监控粒度** | **采样点个数** |
| ---------------- | ------------ | -------------- |
| 30 min | 3 min | 11 |
| 1 hour | 5 min | 13 |
| 6 hour | 30 min | 13 |
| 12 hour | 1 hour | 13 |
| 1 day | 2 hour | 13 |
| 7 day | 12 hour | 15 |


* 平均流速计算方式
  * (时刻 B 的累积流量 - 时刻 A 的累积流量)(单位：bit)/ (时刻 B - 时刻 A)(单位：秒)= 时刻 B 的流速(单位：bips)。
  * 如果时刻 A 为云主机创建的时间，则流速为 0。

* 流量的计算方式
  * (时刻 B 的累积流量 - 时刻 A 的累积流量)(单位：bit) = 时刻 B 的流量
  * 如果时刻 A 为云主机创建的时间，则流量为 0。

* 请求数的计算方式
  * (时刻 B 的累积请求数 - 时刻 A 的累积请求数)(单位：次) = 时刻 B 的请求数
  * 如果时刻 A 为负载均衡第一次接收到的请求时间，则请求数为 0

## 网络 QOS
### 功能点
| **序号** | **功能点** | **描述** | **备注** |
| -------- | ---------- | -------- | -------- |
| 1 | 设置从实例流向外网的最大带宽 | 1. 允许用户设置实例出外网的最大带宽（即下行最大带宽）。 <br/>2. 允许用户设置的最大带宽范围为：[1, 100]（单位：Mbps），且只能为整数。 <br/>3. 不允许用户设置实例入外网的最大带宽，即上行带宽不做限制。 <br/>4. 上行带宽不能影响下行带宽。[见各云厂商的带宽限制情况。](http://note.youdao.com/) <br/>5. 内网之间的通信没有带宽限制。| |
| 2 | 设置公网 IP 的最大带宽 | 同，如果 Ecmc 只有在弹性 IP 才能上网的情况下。 |

## 网络监控
### 功能点
| **序号** | **功能点** | **描述** | **备注** |
| -------- | ---------- | -------- | -------- |
| 1 | 统计从外网流入各实例的流量 | 统计从公网流向各实例的流量，用于查看用户上行流量的使用情况。 | 监控 |
| 2 | 统计各实例流向外网的流量 | 统计各实例流向公网的流量，为选择按需付费使用云主机的用户提供精确的实际使用用量。 | 监控、计费 |
| 3 | 统计从内网流向各实例的流量 | 便于用户查看从非外网流入实例的流量 | 监控 |
| 4 | 统计从各实例流向内网的流量 | 便于用户查看从实例流入非外网的流量 | 监控 |
| 5 | 统计从各路由器外网接口流入内网的流量 | 便于运维人员查看每个用户各私有网络的上行流量 | 监控 |
| 6 | 统计从内网流出各路由器外网接口的流量 | 便于运维人员查看每个用户各私有网络的下行流量 | 监控、计费 |
| 7 | 统计从外网流入各实例的平均流速 | 便于用户查看在某时间周期内各实例上行的平均流速 | 监控 |
| 8 | 统计各实例流向外网的平均流速 | 便于用户查看在某时间周期内各实例下行的平均流速 | 监控 |
| 9 | 统计从内网流向各实例的平均流速 | 便于用户查看从非外网流入实例的平均流速 | 监控 |
| 10 | 统计从各实例流向内网的平均流速 | 便于用户查看从实例流入非外网的平均流速  | 监控 |

## 负载均衡监控
### 功能点
| **序号** | **功能点** | **描述** | **备注** |
| -------- | ---------- | -------- | -------- |
| 1 | 流入流量 | 统计从外部访问负载均衡所消耗的流量（包括所有监听器协议，HTTP、TCP、UDP）| 监控 |
| 2 | 流出流量 | 表示负载均衡访问外部所消耗的流量（包括所有监听器协议，HTTP、TCP、UDP）| 监控 |
| 3 | 请求数 | 统计监听器 HTTP 协议接收到的请求数 | 监控 |
| 4 | 各 member 响应延迟时间 | 统计监听器 HTTP 协议向后端实例发出请求到实例返回响应给负载均衡服务器所用的时间 | 监控 |
| 5 | HTTP 的连接总数 | 统计监听器 HTTP 协议下发起请求并建立了 HTTP 连接的总数 | 监控 |
| 6 | TCP 的连接总数 | 统计监听器 TCP 协议下发起请求并建立了 TCP 连接的总数 | 监控 |
| 7 | 后端返回给负载均衡服务的各 1xx/2xx/3xx/4xx/5xx 响应数 | 统计监听器 HTTP 协议下所有后端返回的，对应状态码的响应数 | 监控 |

## 负载均衡会话保持
### 功能点
| **序号** | **功能点** | **描述** | **备注** |
| -------- | ---------- | -------- | -------- |
| 1 | TCP 方式的负载均衡会话保持 | 基于客户 IP |
| 2 | HTTP 方式的负载均衡会话保持 | 1. 第一次请求，客户端 http requesst 进入负载均衡器。<br/>2. 根据负载均衡策略选择一台服务器，服务器生成响应后，persistence 模块会在响应头部加上 cookie 信息（添加 Set-Cookie），并在 cookie 中设置它在客户端中的存活时间（expire，用户可以自己选择，一天上限... 1s~86400s）。这样一来客户端浏览器设置中就包含服务器信息的特定 cookie了。<br/>3. 客户端收到响应后，会将 cookie 信息写入本地。<br/>4. 再次请求的时候，http request with cookie 发到指定的服务器。<br/>5. 后端服务器从请求头中获取到 cookie 信息，分析 cookie，如果对应的 cookie 是正确的就生成响应，并将响应发回给客户端。<br/> |
